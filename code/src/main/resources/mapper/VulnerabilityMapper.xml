<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jettech.code.mapper.VulnerabilityMapper">
    <resultMap id="VulnerabilityMap" type="com.jettech.code.entity.Vulnerability">
        <id property="id" column="id"/>
        <result property="dependencyId" column="dependency_id"/>
        <result property="cveId" column="cve_id"/>
        <result property="cweId" column="cwe_id"/>
        <result property="severity" column="severity"/>
        <result property="cvssScore" column="cvss_score"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="affectedVersion" column="affected_version"/>
        <result property="fixedVersion" column="fixed_version"/>
        <result property="references" column="references"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="findByDependencyId" resultMap="VulnerabilityMap">
        SELECT * FROM vulnerability WHERE dependency_id = #{dependencyId} ORDER BY 
        CASE severity
            WHEN 'CRITICAL' THEN 1
            WHEN 'HIGH' THEN 2
            WHEN 'MEDIUM' THEN 3
            WHEN 'LOW' THEN 4
            ELSE 5
        END,
        cvss_score DESC
    </select>

    <select id="findById" resultMap="VulnerabilityMap">
        SELECT * FROM vulnerability WHERE id = #{id}
    </select>

    <select id="findBySeverity" resultMap="VulnerabilityMap">
        SELECT * FROM vulnerability WHERE dependency_id = #{dependencyId} AND severity = #{severity} ORDER BY cvss_score DESC
    </select>

    <insert id="insert" parameterType="com.jettech.code.entity.Vulnerability" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO vulnerability (dependency_id, cve_id, cwe_id, severity, cvss_score, title, description, affected_version, fixed_version, references, status, created_at)
        VALUES (#{dependencyId}, #{cveId}, #{cweId}, #{severity}, #{cvssScore}, #{title}, #{description}, #{affectedVersion}, #{fixedVersion}, #{references}, #{status}, #{createdAt})
    </insert>

    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO vulnerability (dependency_id, cve_id, cwe_id, severity, cvss_score, title, description, affected_version, fixed_version, references, status, created_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.dependencyId}, #{item.cveId}, #{item.cweId}, #{item.severity}, #{item.cvssScore}, #{item.title}, #{item.description}, #{item.affectedVersion}, #{item.fixedVersion}, #{item.references}, #{item.status}, #{item.createdAt})
        </foreach>
    </insert>

    <update id="update" parameterType="com.jettech.code.entity.Vulnerability">
        UPDATE vulnerability
        <set>
            <if test="cveId != null">cve_id = #{cveId},</if>
            <if test="cweId != null">cwe_id = #{cweId},</if>
            <if test="severity != null">severity = #{severity},</if>
            <if test="cvssScore != null">cvss_score = #{cvssScore},</if>
            <if test="title != null">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="affectedVersion != null">affected_version = #{affectedVersion},</if>
            <if test="fixedVersion != null">fixed_version = #{fixedVersion},</if>
            <if test="references != null">references = #{references},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteByDependencyId">
        DELETE FROM vulnerability WHERE dependency_id = #{dependencyId}
    </delete>

    <delete id="deleteById">
        DELETE FROM vulnerability WHERE id = #{id}
    </delete>
</mapper>
