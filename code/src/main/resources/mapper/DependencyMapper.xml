<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jettech.code.mapper.DependencyMapper">
    <resultMap id="DependencyMap" type="com.jettech.code.entity.Dependency">
        <id property="id" column="id"/>
        <result property="serviceId" column="service_id"/>
        <result property="name" column="name"/>
        <result property="version" column="version"/>
        <result property="groupId" column="group_id"/>
        <result property="artifactId" column="artifact_id"/>
        <result property="type" column="type"/>
        <result property="scope" column="scope"/>
        <result property="license" column="license"/>
        <result property="licenseStatus" column="license_status"/>
        <result property="purl" column="purl"/>
        <result property="filePath" column="file_path"/>
        <result property="checksum" column="checksum"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="findByServiceId" resultMap="DependencyMap">
        SELECT * FROM dependency WHERE service_id = #{serviceId} ORDER BY created_at DESC
    </select>

    <select id="findById" resultMap="DependencyMap">
        SELECT * FROM dependency WHERE id = #{id}
    </select>

    <select id="findByServiceIdAndLicenseStatus" resultMap="DependencyMap">
        SELECT * FROM dependency WHERE service_id = #{serviceId} AND license_status = #{licenseStatus} ORDER BY created_at DESC
    </select>

    <insert id="insert" parameterType="com.jettech.code.entity.Dependency" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO dependency (service_id, name, version, group_id, artifact_id, type, scope, license, license_status, purl, file_path, checksum, created_at)
        VALUES (#{serviceId}, #{name}, #{version}, #{groupId}, #{artifactId}, #{type}, #{scope}, #{license}, #{licenseStatus}, #{purl}, #{filePath}, #{checksum}, #{createdAt})
    </insert>

    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO dependency (service_id, name, version, group_id, artifact_id, type, scope, license, license_status, purl, file_path, checksum, created_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.serviceId}, #{item.name}, #{item.version}, #{item.groupId}, #{item.artifactId}, #{item.type}, #{item.scope}, #{item.license}, #{item.licenseStatus}, #{item.purl}, #{item.filePath}, #{item.checksum}, #{item.createdAt})
        </foreach>
    </insert>

    <update id="update" parameterType="com.jettech.code.entity.Dependency">
        UPDATE dependency
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="version != null">version = #{version},</if>
            <if test="groupId != null">group_id = #{groupId},</if>
            <if test="artifactId != null">artifact_id = #{artifactId},</if>
            <if test="type != null">type = #{type},</if>
            <if test="scope != null">scope = #{scope},</if>
            <if test="license != null">license = #{license},</if>
            <if test="licenseStatus != null">license_status = #{licenseStatus},</if>
            <if test="purl != null">purl = #{purl},</if>
            <if test="filePath != null">file_path = #{filePath},</if>
            <if test="checksum != null">checksum = #{checksum},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteByServiceId">
        DELETE FROM dependency WHERE service_id = #{serviceId}
    </delete>

    <delete id="deleteById">
        DELETE FROM dependency WHERE id = #{id}
    </delete>

    <select id="findByApplicationId" resultMap="DependencyMap">
        SELECT d.* FROM dependency d
        INNER JOIN service s ON d.service_id = s.id
        WHERE s.application_id = #{applicationId}
        ORDER BY d.created_at DESC
    </select>
</mapper>
